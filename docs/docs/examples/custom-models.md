# Custom Models Example

Learn how to use custom MuJoCo models with meshes and textures.

## Overview

This example demonstrates:

- Loading models from external XML files
- Working with mesh files
- Setting up complex scenes
- Adding multiple scenes to a project

## Project Structure

```
my_robot_demo/
├── demo.py
├── models/
│   ├── robot.xml
│   └── meshes/
│       ├── body.stl
│       ├── arm.stl
│       └── leg.stl
└── dist/  (generated by build)
```

## Complete Code

```python
"""Custom Models Example

Demonstrates loading and using custom MuJoCo models with external assets.
"""

from pathlib import Path
import mujoco
import muwanx as mwx


def main():
    # Create builder
    builder = mwx.Builder()

    # Add project
    robot_project = builder.add_project(name="Robot Demos")

    # Define model directory
    model_dir = Path(__file__).parent / "models"

    # Scene 1: Robot in neutral pose
    neutral_model = mujoco.MjModel.from_xml_path(
        str(model_dir / "robot.xml")
    )
    scene1 = robot_project.add_scene(
        model=neutral_model,
        name="Neutral Pose",
        id="neutral"
    )

    # Scene 2: Robot in ready pose
    ready_model = mujoco.MjModel.from_xml_path(
        str(model_dir / "robot.xml")
    )
    scene2 = robot_project.add_scene(
        model=ready_model,
        name="Ready Pose",
        id="ready",
        initial_qpos={
            "hip_l": 0.5,
            "knee_l": -1.0,
            "ankle_l": 0.5,
            "hip_r": 0.5,
            "knee_r": -1.0,
            "ankle_r": 0.5,
        }
    )

    # Scene 3: Robot with policy
    policy_model = mujoco.MjModel.from_xml_path(
        str(model_dir / "robot.xml")
    )
    scene3 = robot_project.add_scene(
        model=policy_model,
        name="Walking",
        id="walking",
        initial_qpos={
            "hip_l": 0.2,
            "knee_l": -0.5,
            "ankle_l": 0.2,
            "hip_r": -0.2,
            "knee_r": -0.5,
            "ankle_r": 0.2,
        }
    )

    # Add policy to scene 3
    scene3.add_policy(
        path="models/walk_policy.onnx",
        observation_config={
            "qpos": True,
            "qvel": True
        },
        action_config={
            "type": "position",
            "actuators": [
                "hip_l", "knee_l", "ankle_l",
                "hip_r", "knee_r", "ankle_r"
            ],
            "scale": 0.5,
            "clip": [-1.0, 1.0]
        }
    )

    # Build and launch
    app = builder.build()
    app.launch()

    print("✓ Custom models example completed!")


if __name__ == "__main__":
    main()
```

## Robot Model XML

Example `models/robot.xml`:

```xml
<mujoco model="humanoid">
  <compiler angle="degree" inertiafromgeom="true"/>

  <default>
    <joint armature="1" damping="1" limited="true"/>
    <geom conaffinity="1" condim="3" density="1000"
          friction="1 0.5 0.005" rgba="0.8 0.6 0.4 1"/>
  </default>

  <asset>
    <mesh name="body_mesh" file="meshes/body.stl"/>
    <mesh name="arm_mesh" file="meshes/arm.stl"/>
    <mesh name="leg_mesh" file="meshes/leg.stl"/>
  </asset>

  <worldbody>
    <light diffuse="0.5 0.5 0.5" pos="0 0 3" dir="0 0 -1"/>
    <geom type="plane" size="2 2 0.1" rgba="0.9 0.9 0.9 1"/>

    <!-- Torso -->
    <body name="torso" pos="0 0 1.2">
      <freejoint/>
      <geom type="mesh" mesh="body_mesh"/>

      <!-- Left leg -->
      <body name="thigh_l" pos="0 0.1 -0.3">
        <joint name="hip_l" type="hinge" axis="1 0 0"
               range="-90 90"/>
        <geom type="mesh" mesh="leg_mesh"/>

        <body name="shin_l" pos="0 0 -0.4">
          <joint name="knee_l" type="hinge" axis="1 0 0"
                 range="-150 0"/>
          <geom type="mesh" mesh="leg_mesh" size="0.8 0.8 0.8"/>

          <body name="foot_l" pos="0 0 -0.4">
            <joint name="ankle_l" type="hinge" axis="1 0 0"
                   range="-45 45"/>
            <geom type="box" size="0.1 0.05 0.02"/>
          </body>
        </body>
      </body>

      <!-- Right leg (symmetric) -->
      <body name="thigh_r" pos="0 -0.1 -0.3">
        <joint name="hip_r" type="hinge" axis="1 0 0"
               range="-90 90"/>
        <geom type="mesh" mesh="leg_mesh"/>

        <body name="shin_r" pos="0 0 -0.4">
          <joint name="knee_r" type="hinge" axis="1 0 0"
                 range="-150 0"/>
          <geom type="mesh" mesh="leg_mesh" size="0.8 0.8 0.8"/>

          <body name="foot_r" pos="0 0 -0.4">
            <joint name="ankle_r" type="hinge" axis="1 0 0"
                   range="-45 45"/>
            <geom type="box" size="0.1 0.05 0.02"/>
          </body>
        </body>
      </body>
    </body>
  </worldbody>

  <actuator>
    <motor name="hip_l" joint="hip_l" gear="100"/>
    <motor name="knee_l" joint="knee_l" gear="100"/>
    <motor name="ankle_l" joint="ankle_l" gear="50"/>
    <motor name="hip_r" joint="hip_r" gear="100"/>
    <motor name="knee_r" joint="knee_r" gear="100"/>
    <motor name="ankle_r" joint="ankle_r" gear="50"/>
  </actuator>
</mujoco>
```

## Working with Meshes

### Mesh File Formats

MuJoCo supports:

- **STL**: Simple triangle meshes
- **OBJ**: Meshes with textures
- **MSH**: MuJoCo's native format

### Creating Mesh Assets

In your MuJoCo XML:

```xml
<asset>
  <!-- STL meshes -->
  <mesh name="body" file="meshes/body.stl"/>
  <mesh name="arm" file="meshes/arm.stl"/>

  <!-- OBJ with scale -->
  <mesh name="head" file="meshes/head.obj" scale="0.001 0.001 0.001"/>

  <!-- Textures -->
  <texture name="skin" type="2d" file="textures/skin.png"/>
  <material name="robot_mat" texture="skin"/>
</asset>
```

### Using Meshes

Reference meshes in geoms:

```xml
<geom type="mesh" mesh="body" material="robot_mat"/>
```

## Multiple Projects

Organize different robot types:

```python
def main():
    builder = mwx.Builder()

    # Humanoid project
    humanoid = builder.add_project(name="Humanoid", id="humanoid")
    humanoid_model = mujoco.MjModel.from_xml_path("models/humanoid.xml")
    humanoid.add_scene(model=humanoid_model, name="Walking")

    # Quadruped project
    quadruped = builder.add_project(name="Quadruped", id="quadruped")
    quadruped_model = mujoco.MjModel.from_xml_path("models/quadruped.xml")
    quadruped.add_scene(model=quadruped_model, name="Trotting")

    # Manipulator project
    manipulator = builder.add_project(name="Manipulator", id="arm")
    arm_model = mujoco.MjModel.from_xml_path("models/arm.xml")
    manipulator.add_scene(model=arm_model, name="Reaching")

    app = builder.build()
    app.launch()
```

## Loading from Different Sources

### From File Path

```python
model = mujoco.MjModel.from_xml_path("path/to/model.xml")
```

### From String

```python
xml_string = """
<mujoco>
  <!-- Your model here -->
</mujoco>
"""
model = mujoco.MjModel.from_xml_string(xml_string)
```

### From MJCF File

```python
model = mujoco.MjModel.from_xml_path("model.mjcf")
```

### With Preprocessing

```python
from pathlib import Path

# Read and modify XML
xml_path = Path("models/robot.xml")
xml_content = xml_path.read_text()

# Modify parameters
xml_content = xml_content.replace(
    'density="1000"',
    'density="2000"'
)

# Create model
model = mujoco.MjModel.from_xml_string(xml_content)
```

## Advanced Scene Configuration

### Parametric Scene Generation

```python
def create_scene_with_mass(project, mass_value):
    """Create a scene with a specific mass parameter."""
    xml = f"""
    <mujoco>
      <worldbody>
        <geom type="plane" size="1 1 0.1"/>
        <body pos="0 0 1">
          <joint type="free"/>
          <geom type="box" size="0.1 0.1 0.1" mass="{mass_value}"/>
        </body>
      </worldbody>
    </mujoco>
    """
    model = mujoco.MjModel.from_xml_string(xml)
    project.add_scene(
        model=model,
        name=f"Mass {mass_value}kg",
        id=f"mass-{int(mass_value)}"
    )

# Generate scenes
project = builder.add_project(name="Mass Experiments")
for mass in [0.5, 1.0, 2.0, 5.0]:
    create_scene_with_mass(project, mass)
```

### Scene Variants

```python
def add_gait_variants(project, model_path, policy_path):
    """Add multiple gait variants of the same robot."""
    gaits = {
        "walk": {"speed": 1.0, "scale": 0.3},
        "trot": {"speed": 1.5, "scale": 0.5},
        "gallop": {"speed": 2.5, "scale": 0.8}
    }

    for gait_name, params in gaits.items():
        model = mujoco.MjModel.from_xml_path(model_path)
        scene = project.add_scene(
            model=model,
            name=gait_name.capitalize(),
            id=gait_name,
            initial_qpos={"target_speed": params["speed"]}
        )
        scene.add_policy(
            path=policy_path,
            observation_config={"qpos": True, "qvel": True},
            action_config={
                "type": "position",
                "scale": params["scale"]
            }
        )
```

## Best Practices

### File Organization

```
project/
├── demo.py               # Main script
├── models/              # MuJoCo models
│   ├── robot1.xml
│   ├── robot2.xml
│   └── assets/
│       ├── meshes/
│       │   ├── *.stl
│       │   └── *.obj
│       └── textures/
│           └── *.png
├── policies/            # ONNX policies
│   ├── policy1.onnx
│   └── policy2.onnx
└── dist/               # Build output (gitignored)
```

### Path Handling

```python
from pathlib import Path

# Get script directory
script_dir = Path(__file__).parent

# Construct paths
model_path = script_dir / "models" / "robot.xml"
policy_path = script_dir / "policies" / "policy.onnx"

# Use in Muwanx
model = mujoco.MjModel.from_xml_path(str(model_path))
scene.add_policy(path=str(policy_path), ...)
```

### Model Validation

```python
def validate_model(model_path):
    """Validate a MuJoCo model loads correctly."""
    try:
        model = mujoco.MjModel.from_xml_path(str(model_path))
        print(f"✓ Model valid: {model_path}")
        print(f"  - DOFs: {model.nv}")
        print(f"  - Bodies: {model.nbody}")
        print(f"  - Actuators: {model.nu}")
        return model
    except Exception as e:
        print(f"✗ Model error: {model_path}")
        print(f"  {e}")
        return None
```

## Troubleshooting

### Mesh Not Found

Ensure mesh paths are relative to the XML file:

```xml
<!-- Correct -->
<mesh name="body" file="meshes/body.stl"/>

<!-- Wrong (absolute path) -->
<mesh name="body" file="/absolute/path/meshes/body.stl"/>
```

### Model Fails to Load

Check for XML errors:

```python
try:
    model = mujoco.MjModel.from_xml_path("model.xml")
except Exception as e:
    print(f"Error loading model: {e}")
```

### Large File Sizes

Optimize meshes:

- Reduce polygon count
- Use compressed formats
- Remove unnecessary detail

## Next Steps

- [Adding Policies](../user-guide/adding-policies.md) - Add control to your models
- [Building Projects](../user-guide/building-projects.md) - Deploy your application
- [VR Support](../advanced/vr-support.md) - Enable VR viewing
